let movies = [
    {
        "title": "American Hustle",
        "audience_score": 74,
        "critic_score": 85
    },
    {
        "title": "Gravity",
        "audience_score": 79,
        "critic_score": 87
    },
    {
        "title": "12 Years a Slave",
        "audience_score": 86,
        "critic_score": 88
    },
    {
        "title": "Her",
        "audience_score": 84,
        "critic_score": 91
    },
    {
        "title": "The Wolf of Wall Street",
        "audience_score": 75,
        "critic_score": 73
    },
    {
        "title": "Nebraska",
        "audience_score": 82,
        "critic_score": 86
    },
    {
        "title": "Philomena",
        "audience_score": 84,
        "critic_score": 85
    },
    {
        "title": "Captain Phillips",
        "audience_score": 85,
        "critic_score": 87
    },
    {
        "title": "Dallas Buyers Club",
        "audience_score": 86,
        "critic_score": 87
    },
    {
        "title": "Boyhood",
        "audience_score": 78,
        "critic_score": 86
    },
    {
        "title": "Selma",
        "audience_score": 79,
        "critic_score": 86
    },
    {
        "title": "Birdman",
        "audience_score": 80,
        "critic_score": 87
    },
    {
        "title": "The Theory of Everything",
        "audience_score": 81,
        "critic_score": 79
    },
    {
        "title": "American Sniper",
        "audience_score": 75,
        "critic_score": 69
    },
    {
        "title": "The Grand Budapest Hotel",
        "audience_score": 85,
        "critic_score": 88
    },
    {
        "title": "The Imitation Game",
        "audience_score": 86,
        "critic_score": 86
    },
    {
        "title": "Whiplash",
        "audience_score": 91,
        "critic_score": 91
    },
    {
        "title": "Brooklyn",
        "audience_score": 83,
        "critic_score": 88
    },
    {
        "title": "Spotlight",
        "audience_score": 87,
        "critic_score": 89
    },
    {
        "title": "The Big Short",
        "audience_score": 85,
        "critic_score": 85
    },
    {
        "title": "Mad Max: Fury Road",
        "audience_score": 86,
        "critic_score": 91
    },
    {
        "title": "Room",
        "audience_score": 88,
        "critic_score": 88
    },
    {
        "title": "The Martian",
        "audience_score": 86,
        "critic_score": 86
    },
    {
        "title": "Bridge of Spies",
        "audience_score": 82,
        "critic_score": 84
    },
    {
        "title": "The Revenant",
        "audience_score": 82,
        "critic_score": 79
    },
    {
        "title": "Fences",
        "audience_score": 74,
        "critic_score": 83
    },
    {
        "title": "Moonlight",
        "audience_score": 75,
        "critic_score": 85
    },
    {
        "title": "La La Land",
        "audience_score": 82,
        "critic_score": 87
    },
    {
        "title": "Manchester by the Sea",
        "audience_score": 80,
        "critic_score": 89
    },
    {
        "title": "Hell or High Water",
        "audience_score": 85,
        "critic_score": 89
    },
    {
        "title": "Hidden Figures",
        "audience_score": 84,
        "critic_score": 84
    },
    {
        "title": "Arrival",
        "audience_score": 82,
        "critic_score": 88
    },
    {
        "title": "Lion",
        "audience_score": 85,
        "critic_score": 82
    },
    {
        "title": "Hacksaw Ridge",
        "audience_score": 87,
        "critic_score": 84
    },
    {
        "title": "The Post",
        "audience_score": 72,
        "critic_score": 79
    },
    {
        "title": "Call Me by Your Name",
        "audience_score": 83,
        "critic_score": 87
    },
    {
        "title": "Lady Bird",
        "audience_score": 78,
        "critic_score": 88
    },
    {
        "title": "Phantom Thread",
        "audience_score": 74,
        "critic_score": 84
    },
    {
        "title": "The Shape of Water",
        "audience_score": 72,
        "critic_score": 81
    },
    {
        "title": "Darkest Hour",
        "audience_score": 78,
        "critic_score": 79
    },
    {
        "title": "Dunkirk",
        "audience_score": 82,
        "critic_score": 87
    },
    {
        "title": "Three Billboards Outside Ebbing, Missouri",
        "audience_score": 83,
        "critic_score": 84
    },
    {
        "title": "Get Out",
        "audience_score": 81,
        "critic_score": 87
    },
    {
        "title": "Roma",
        "audience_score": 75,
        "critic_score": 87
    },
    {
        "title": "The Favourite",
        "audience_score": 74,
        "critic_score": 85
    },
    {
        "title": "Bohemian Rhapsody",
        "audience_score": 67,
        "critic_score": 55
    },
    {
        "title": "Green Book",
        "audience_score": 80,
        "critic_score": 73
    },
    {
        "title": "BlacKkKlansman",
        "audience_score": 78,
        "critic_score": 85
    },
    {
        "title": "A Star Is Born",
        "audience_score": 82,
        "critic_score": 87
    },
    {
        "title": "Vice",
        "audience_score": 64,
        "critic_score": 66
    },
    {
        "title": "Black Panther",
        "audience_score": 79,
        "critic_score": 88
    },
    {
        "title": "Little Women",
        "audience_score": 84,
        "critic_score": 85
    },
    {
        "title": "Once Upon a Time... in Hollywood",
        "audience_score": 74,
        "critic_score": 82
    },
    {
        "title": "Marriage Story",
        "audience_score": 83,
        "critic_score": 88
    },
    {
        "title": "The Irishman",
        "audience_score": 84,
        "critic_score": 88
    },
    {
        "title": "1917",
        "audience_score": 86,
        "critic_score": 86
    },
    {
        "title": "Ford v Ferrari",
        "audience_score": 90,
        "critic_score": 87
    },
    {
        "title": "Parasite (기생충)",
        "audience_score": 89,
        "critic_score": 93
    },
    {
        "title": "Jojo Rabbit",
        "audience_score": 86,
        "critic_score": 79
    },
    {
        "title": "Joker",
        "audience_score": 88,
        "critic_score": 79
    },
    {
        "title": "Mank",
        "audience_score": 63,
        "critic_score": 73
    },
    {
        "title": "Judas and the Black Messiah",
        "audience_score": 84,
        "critic_score": 85
    },
    {
        "title": "Nomadland",
        "audience_score": 78,
        "critic_score": 83
    },
    {
        "title": "The Trial of the Chicago 7",
        "audience_score": 83,
        "critic_score": 82
    },
    {
        "title": "Minari",
        "audience_score": 84,
        "critic_score": 89
    },
    {
        "title": "The Father",
        "audience_score": 89,
        "critic_score": 92
    },
    {
        "title": "Sound of Metal",
        "audience_score": 85,
        "critic_score": 89
    },
    {
        "title": "Promising Young Woman",
        "audience_score": 80,
        "critic_score": 81
    },
    {
        "title": "Licorice Pizza",
        "audience_score": 66,
        "critic_score": 78
    },
    {
        "title": "The Power of the Dog",
        "audience_score": 71,
        "critic_score": 80
    },
    {
        "title": "Nightmare Alley",
        "audience_score": 69,
        "critic_score": 75
    },
    {
        "title": "King Richard",
        "audience_score": 82,
        "critic_score": 78
    },
    {
        "title": "Drive My Car",
        "audience_score": 76,
        "critic_score": 86
    },
    {
        "title": "Belfast",
        "audience_score": 80,
        "critic_score": 77
    },
    {
        "title": "CODA",
        "audience_score": 83,
        "critic_score": 85
    },
    {
        "title": "West Side Story",
        "audience_score": 82,
        "critic_score": 82
    },
    {
        "title": "Dune",
        "audience_score": 85,
        "critic_score": 81
    },
    {
        "title": "Don't Look Up",
        "audience_score": 72,
        "critic_score": 61
    },
    {
        "title": "T\u00e1r",
        "audience_score": 74,
        "critic_score": 83
    },
    {
        "title": "The Banshees of Inisherin",
        "audience_score": 75,
        "critic_score": 86
    },
    {
        "title": "Women Talking",
        "audience_score": 71,
        "critic_score": 76
    },
    {
        "title": "The Fabelmans",
        "audience_score": 79,
        "critic_score": 83
    },
    {
        "title": "Elvis",
        "audience_score": 78,
        "critic_score": 70
    },
    {
        "title": "Everything Everywhere All at Once",
        "audience_score": 81,
        "critic_score": 85
    },
    {
        "title": "Top Gun: Maverick",
        "audience_score": 87,
        "critic_score": 85
    },
    {
        "title": "All Quiet on the Western Front",
        "audience_score": 85,
        "critic_score": 85
    },
    {
        "title": "Avatar: The Way of Water",
        "audience_score": 82,
        "critic_score": 74
    },
    {
        "title": "Triangle of Sadness",
        "audience_score": 76,
        "critic_score": 72
    },
    {
        "title": "Maestro",
        "audience_score": 57,
        "critic_score": 68
    },
    {
        "title": "Poor Things",
        "audience_score": 76,
        "critic_score": 82
    },
    {
        "title": "Oppenheimer",
        "audience_score": 88,
        "critic_score": 89
    },
    {
        "title": "Killers of the Flower Moon",
        "audience_score": 81,
        "critic_score": 85
    },
    {
        "title": "Past Lives",
        "audience_score": 82,
        "critic_score": 88
    },
    {
        "title": "The Zone of Interest",
        "audience_score": 76,
        "critic_score": 84
    },
    {
        "title": "Barbie",
        "audience_score": 72,
        "critic_score": 74
    },
    {
        "title": "American Fiction",
        "audience_score": 85,
        "critic_score": 83
    },
    {
        "title": "The Holdovers",
        "audience_score": 86,
        "critic_score": 89
    },
    {
        "title": "Anatomy of a Fall",
        "audience_score": 84,
        "critic_score": 87
    }
];

let audience_score_enabled = false;

let score = 0;

let choiceMade = false;

function getRandomMovies() {
    const randomIndexes = [];
    while (randomIndexes.length < 2) {
        const randomIndex = Math.floor(Math.random() * movies.length);
        if (!randomIndexes.includes(randomIndex)) {
            randomIndexes.push(randomIndex);
        }
    }
    console.log([movies[randomIndexes[0]], movies[randomIndexes[1]]])
    return [movies[randomIndexes[0]], movies[randomIndexes[1]]];
}

async function fetchMoviePoster(movieTitle) {
    const apiKey = '352d50e929f67aea3a7aca5c902400dd'; // Replace 'YOUR_API_KEY' with your actual API key from TMDB
    const apiUrl = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(movieTitle)}`;

    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        // Check if any movies were found
        if (data.results.length > 0) {
            // Assuming the first result is the most relevant one
            const movie = data.results[0];
            const posterPath = movie.poster_path;

            if (posterPath) {
                // Construct the full URL for the poster
                return `https://image.tmdb.org/t/p/w500/${posterPath}`;
            } else {
                return 'Poster not available';
            }
        } else {
            return 'Movie not found';
        }
    } catch (error) {
        console.error('Error fetching movie poster:', error);
        return null;
    }
}

async function preloadMoviePosters() {
    for (const movie of movies) {
        const posterUrl = await fetchMoviePoster(movie.title);
        movie.posterUrl = posterUrl;
    }
}

function displayPopup() {
    document.getElementById('popupOverlay').style.display = 'block';
}

function hidePopup() {
    document.getElementById('popupOverlay').style.display = 'none';
}

document.getElementById('playBtn').addEventListener('click', function () {
    hidePopup();

});

preloadMoviePosters().then(() => {
    // Introduce a delay of 2 seconds before hiding the loading overlay and showing the content
    setTimeout(() => {
        // Hide loading overlay and show content
        
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('content').style.display = 'block';
    }, 2000); // 2000 milliseconds = 2 seconds
    // Call displayRandomMovies to initially display two random movies
    initialiseFunction();
});

// Add event listener to the toggle switch
document.getElementById('audienceScoreToggle').addEventListener('change', function () {
    audience_score_enabled = this.checked; // Update audience_score_enabled based on the toggle switch state

    if (audience_score_enabled) {
        // Update the game to use audience scores
        console.log("Audience score enabled");
    } else {
        // Update the game to use critic scores
        console.log("Critic score enabled");
    }
});

window.onload = displayPopup;

document.addEventListener("DOMContentLoaded", function () {
    const toggleSwitch = document.getElementById('audienceScoreToggle');
    const audienceText = document.querySelector('.headersection h1');
    const audienceSubText = document.querySelector('.headersection h2 em');

    toggleSwitch.addEventListener('change', function () {
        if (this.checked) {
            // Audience score enabled
            audienceText.innerHTML = "Which of these <span style='color:#e5aa3b; font-weight:900;'>Best Picture Nominees</span> is preferred by <span style='color:#e5aa3b; font-weight:900;'>General Audiences?</span>";
            audienceSubText.textContent = "The general audience score for each film is an aggregate from iMDB, RT Audience Score and MC Audience Score";
        } else {
            // Audience score disabled
            audienceText.innerHTML = "Which of these <span style='color:#e5aa3b; font-weight:900;'>Best Picture Nominees</span> is preferred by <span style='color:#e5aa3b; font-weight:900;'>Critics?</span>";
            audienceSubText.textContent = "The critic score for each film is an aggregate from Letterboxd, RT Critic Score and MC Critic Score";
        }
    });
});

document.getElementById('tryAgainBtn').addEventListener('click', function () {
    score = 0;
    document.getElementById('score').innerText = score;
    document.getElementById('tryAgainBtn').style.visibility = 'hidden'; // Hide the "Try Again" button
    choiceMade = false;

    const movieContainers = document.querySelectorAll('.movie');

    // Apply the hidden class to initiate the scaling animation for each movie container
    movieContainers.forEach(function (container) {
        container.classList.add('hidden');

        setTimeout(() => {
            initialiseFunction();
            removeActive(container);
            
        }, 200); 

        setTimeout(() => {
            resetScores();

            container.classList.remove('hidden');
        }, 500);
    });
});

document.getElementById('nextbutton').addEventListener('click', function () {
    const movieContainers = document.querySelectorAll('.movie');

    // Apply the hidden class to initiate the scaling animation for each movie container
    movieContainers.forEach(function (container) {
        container.classList.add('hidden');
        choiceMade = false;

        setTimeout(() => {
            initialiseFunction();
            removeActive(container);

        }, 200); 

        // After a short delay, remove the hidden class to trigger the animation back to scale 1
        setTimeout(() => {
            resetScores();

            container.classList.remove('hidden');
        }, 500); // Adjust the delay as needed
    });
    document.getElementById('nextbutton').style.visibility = 'hidden'; // Hide the "Try Again" button
});

let movie1, movie2; // Declaring movie1 and movie2 as global variables

function initialiseFunction() {
    [movie1, movie2] = getRandomMovies();
    console.log(movie1, movie2);
    // Update movie titles
    document.getElementById('movieTitle1').innerText = movie1.title;
    document.getElementById('movieTitle2').innerText = movie2.title;

    // Update movie posters
    document.getElementById('moviePoster1').src = movie1.posterUrl;
    document.getElementById('moviePoster2').src = movie2.posterUrl;

    // Add event listeners to each movie container
    document.getElementById('movie1').addEventListener('click', function () {
        if (choiceMade) {
            return;
        } else {
            console.log(movie1);
            checkUserChoice(0); // 0 represents the index of the first movie
        }
    });

    document.getElementById('movie2').addEventListener('click', function () {
        if (choiceMade) {
            return;
        } else {
            console.log(movie2);
            checkUserChoice(1); // 1 represents the index of the second movie
        }
    });
}

function checkUserChoice(userChoiceIndex) {
    let scoreToCompare1, scoreToCompare2;

    // Determine which score to compare based on audience_score_enabled
    if (audience_score_enabled) {
        scoreToCompare1 = movie1.audience_score;
        scoreToCompare2 = movie2.audience_score;
    } else {
        scoreToCompare1 = movie1.critic_score;
        scoreToCompare2 = movie2.critic_score;
    }

    // Compare scores with the user's choice
    if (scoreToCompare1 > scoreToCompare2 && userChoiceIndex === 0) {
        // User is correct
        score++;
        document.getElementById('nextbutton').style.visibility = 'visible'; // Reveal the "Try Again" button
        document.getElementById('movie1').classList.add('correct');
        document.getElementById('movie2').classList.add('incorrect');
    } else if (scoreToCompare2 > scoreToCompare1 && userChoiceIndex === 1) {
        // User is correct
        score++;
        document.getElementById('nextbutton').style.visibility = 'visible'; // Reveal the "Try Again" button
        document.getElementById('movie2').classList.add('correct');
        document.getElementById('movie1').classList.add('incorrect');
    } else if (scoreToCompare2 > scoreToCompare1 && userChoiceIndex === 0){
        // User is wrong
        score = 0;
        document.getElementById('tryAgainBtn').style.visibility = 'visible'; // Reveal the "Try Again" button
        document.getElementById('movie2').classList.add('correct');
        document.getElementById('movie1').classList.add('incorrect');
    }
    else if (scoreToCompare1 > scoreToCompare2 && userChoiceIndex === 1){
        // User is wrong
        score = 0;
        document.getElementById('movie1').classList.add('correct');
        document.getElementById('movie2').classList.add('incorrect');
        document.getElementById('tryAgainBtn').style.visibility = 'visible'; // Reveal the "Try Again" button

    } else {
        // Tie!
        score++;
        document.getElementById('movie1').classList.add('tie');
        document.getElementById('movie2').classList.add('tie');
        document.getElementById('nextbutton').style.visibility = 'visible'; // Reveal the "Try Again" button

    }

    // Update the score displayed on the page
    document.getElementById('score').innerText = score;

    updateHighestScore(score);

    // Populate the score fields with the scores of the movies

    document.getElementById('movie1Score').innerText = scoreToCompare1;
    document.getElementById('movie2Score').innerText = scoreToCompare2;

    choiceMade = true;
}


document.addEventListener("DOMContentLoaded", function () {
    // Add event listener to each movie container
    const movieContainers = document.querySelectorAll('.movie');
    movieContainers.forEach(function(container) {
        container.addEventListener('click', function() {
            addActive(container);
            toggleActiveOthers(container);
        });
    });
});

function addActive(container) {
    container.classList.add('active');
}

function removeActive(container) {
    container.classList.remove('active');
    container.classList.remove('incorrect');
    container.classList.remove('correct');
    container.classList.remove('tie');

    
}

function toggleActiveOthers(clickedContainer) {
    const movieContainers = document.querySelectorAll('.movie');
    movieContainers.forEach(function(container) {
        if (container !== clickedContainer) {
            addActive(container);
        }
    });
}

function resetScores() {
    document.getElementById('movie1Score').innerText = '';
    document.getElementById('movie2Score').innerText = '';
    
}

// Function to set a cookie
function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
}

// Function to get a cookie
function getCookie(name) {
    const keyValue = document.cookie.match(`(^|;) ?${name}=([^;]*)(;|$)`);
    return keyValue ? keyValue[2] : null;
}

// Function to update the displayed highest score
function updateDisplayedHighestScore() {
    const highestScore = getCookie('highest_score');
    if (highestScore) {
        document.getElementById('highestScore').innerText = `Highest Score: ${highestScore}`;
    } else {
        document.getElementById('highestScore').innerText = 'Highest Score: None';
    }
}

// Call the function to update the displayed highest score after loading the page
window.onload = function() {
    updateDisplayedHighestScore();
};

// Update the highest score after updating the highest score cookie
function updateHighestScore(score) {
    const highestScore = parseInt(getCookie('highest_score')) || 0;
    if (score > highestScore) {
        setCookie('highest_score', score, 365); // Store the highest score for 1 year
        updateDisplayedHighestScore(); // Update the displayed highest score
    }
}
